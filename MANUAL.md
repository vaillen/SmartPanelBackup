# Инструкция по использованию Laravel Backup Tool

## Общая информация

Laravel Backup Tool - это инструмент для автоматического резервного копирования Laravel-сайтов, который выполняет:
1. Резервное копирование файлов сайтов
2. Резервное копирование баз данных
3. Автоматическую ротацию старых бэкапов
4. Ежедневные проверки изменений

## Расположение файлов

### На сервере с сайтами (удаленный сервер):
- Временная директория для бэкапов: `~/laravel-backup-temp/`
- Сайты находятся в их стандартных директориях (например, `/home/user/public_html/`)

### На сервере с бэкапами (локальный сервер):
- Основная директория бэкапов: `/laravel-backup-script/`
- Для каждого сайта создается поддиректория с именем домена
- Структура бэкапов:
  ```
  /laravel-backup-script/
  ├── example.com/
  │   ├── files_2025-02-11_130000.tar.gz
  │   └── db_2025-02-11_130000.sql.gz
  ├── another-site.com/
  │   ├── files_2025-02-11_130000.tar.gz
  │   └── db_2025-02-11_130000.sql.gz
  ```

## Как это работает

1. **Время запуска**
   - Скрипт запускается автоматически каждый день в 13:00 по Киеву (11:00 UTC)
   - Логи записываются в `/var/log/laravel-backup.log`

2. **Процесс бэкапа**
   - Скрипт проверяет каждый сайт на наличие изменений за последние 24 часа
   - Если найдены изменения или нет бэкапа за сегодня:
     * Создается архив файлов сайта (исключая node_modules)
     * Создается дамп базы данных
     * Файлы копируются на сервер с бэкапами
   - Если изменений нет и бэкап за сегодня существует - сайт пропускается

3. **Ротация бэкапов**
   - Старые бэкапы автоматически удаляются согласно настройкам в .env
   - По умолчанию хранятся последние 7 бэкапов файлов и 7 бэкапов баз данных

## Доступ к бэкапам

1. **SSH доступ**
   ```bash
   ssh user@backup-server
   cd /laravel-backup-script
   ```

2. **Структура бэкапов**
   - Файлы: `files_ДАТА_ВРЕМЯ.tar.gz`
   - Базы данных: `db_ДАТА_ВРЕМЯ.sql.gz`

3. **Восстановление из бэкапа**
   - Файлы:
     ```bash
     tar -xzf files_ДАТА_ВРЕМЯ.tar.gz
     ```
   - База данных:
     ```bash
     gunzip < db_ДАТА_ВРЕМЯ.sql.gz | mysql -u USER -p DATABASE
     ```

## Мониторинг

1. **Логи**
   - Все действия записываются в `/var/log/laravel-backup.log`
   - Формат логов включает:
     * Время операции
     * Имя сайта
     * Статус операции
     * Ошибки (если есть)

2. **Проверка статуса**
   ```bash
   tail -f /var/log/laravel-backup.log
   ```

## Безопасность

- Все соединения выполняются по SSH с использованием ключей
- Бэкапы хранятся в директории, доступной только root
- Пароли баз данных не сохраняются, а берутся из .env файлов сайтов

## Настройка новых сайтов

1. Убедитесь, что у сайта есть корректный .env файл с настройками базы данных
2. Сайт будет автоматически обнаружен и добавлен в список для бэкапа

## Контакты для поддержки

При возникновении проблем или вопросов обращайтесь:
- Email: support@example.com
- Телефон: +1234567890
